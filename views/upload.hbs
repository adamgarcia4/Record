<div id="upload">

  <h1>Upload Your Images</h1>

  <script src="../javascripts/upload.js"></script>

    <form enctype="multipart/form-data" action="javascript:upload()">
      <input type="file" name="audio" id="audio" />
      <button type="submit" id="btn" >Upload Files!</button>
    </form>
	

    <script>
    	//Script to send audio file to AWS when file is loaded.

	    //executes when input audio changes 
    	document.getElementById("audio").onchange=function() {
    		var files = document.getElementById("audio").files;
    		var file = files[0];
    		if(file == null) {
    			alert("No File Selected");
    		} else {
    			console.log("Get signed Request");
    			getSignedRequest(file);
    		}
    	};

    	var getSignedRequest = function(file) {
            //Gets a signed GET Request
            console.log('getSignedRequestInit');
    		var xhr = new XMLHttpRequest();
    		xhr.open("GET", "/aws/sign_s3?file_name=" + file.name + "&file_type=" + file.type); //opens a get request with given params
            console.log('xhrOnreadyStateInit');
    		xhr.onreadystatechange = function() {
    			//fires callback when state changes
    			console.log('hi');
                console.log(xhr.readyState, xhr.status);
    			if(xhr.readyState === 4) {
    				//XHR done receiving header/body content
    				if(xhr.status === 200) {
    					//XHR HTML Status 200 : No errors
    					var response = JSON.parse(xhr.responseText);
    					console.log("Upload file");
                        console.log('response is: ' + response.signed_request);
    					uploadFile(file, response.URL_put);
    				}
    				else {
    					//status is not 200, so couldn't get signed url from backend
    					alert("Could not get signed URL");
    				}
    			}
    		}
			xhr.send();
    	};

    	var uploadFile = function(file, signed_put_URL) {
            //takes a signed PUT request, uploads file
    		console.log('uploadFileInit');
            var xhr = new XMLHttpRequest();
            console.log(signed_put_URL);
    		xhr.open("PUT", signed_put_URL);
    		//sets access control level for AWS
    		xhr.setRequestHeader('x-amz-acl', 'public-read');
    		xhr.onerror = function() {
    			alert("Couldn't upload file");
    		}
    		console.log("Sending File : ", file);
    		xhr.send(file);
    	};
    </script>


</div>
